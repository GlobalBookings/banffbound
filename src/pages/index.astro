---
import BaseLayout from '../layouts/BaseLayout.astro';
import Parser from 'rss-parser';
import { blogPosts } from '../data/blogPosts';

const featuredPosts = blogPosts.slice(0, 4);

const parser = new Parser({
  customFields: {
    item: [
      ['calendarEvent:EventDates', 'eventDates'],
    ],
  },
});

let upcomingEvents: any[] = [];
try {
  const feed = await parser.parseURL('https://www.banff.ca/RSSFeed.aspx?ModID=58&CID=Events-25');
  upcomingEvents = (feed.items || []).slice(0, 3).map(item => {
    const desc = (item.description || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
    const parts = desc.split('Description:');
    const clean = parts.length > 1 ? parts[1].trim() : desc;
    return {
      title: item.title || '',
      link: item.link || '',
      dates: item.eventDates?.trim() || '',
      description: clean.slice(0, 150) + (clean.length > 150 ? '...' : ''),
    };
  });
} catch (e) {
  // Events fetch failed silently
}

const categories = [
  {
    title: 'Things to Do',
    description: 'From scenic gondola rides to serene lake walks, discover unforgettable experiences in the heart of the Rockies.',
    href: '/things-to-do',
    icon: '&#128507;',
    image: 'https://images.unsplash.com/photo-1503614472-8c93d56e92ce?w=600&q=80',
  },
  {
    title: 'Eat & Drink',
    description: 'Savor world-class dining, cozy mountain cafes, craft breweries, and everything in between.',
    href: '/eat-and-drink',
    icon: '&#127860;',
    image: 'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=600&q=80',
  },
  {
    title: 'Shopping',
    description: 'Browse unique local boutiques, outdoor gear shops, Indigenous art, and handcrafted souvenirs.',
    href: '/shopping',
    icon: '&#128717;',
    image: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=600&q=80',
  },
  {
    title: 'Activities',
    description: 'Hit the slopes, paddle pristine lakes, hike alpine trails, and chase wildlife year-round.',
    href: '/activities',
    icon: '&#9968;',
    image: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=600&q=80',
  },
  {
    title: 'Iconic Lakes',
    description: 'Lake Louise, Moraine Lake, Peyto Lake, and more. Explore the turquoise jewels of the Canadian Rockies.',
    href: '/lakes',
    icon: '&#128167;',
    image: 'https://images.unsplash.com/photo-1503614472-8c93d56e92ce?w=600&q=80',
  },
  {
    title: 'Tours & Adventures',
    description: 'Book guided tours, day trips, wildlife safaris, and unique experiences with top-rated local operators.',
    href: '/tours',
    icon: '&#127760;',
    image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&q=80',
  },
];

const highlights = [
  { stat: '6,641 km\u00B2', label: 'National Park Area' },
  { stat: '1,885m', label: 'Town Elevation' },
  { stat: '3+', label: 'World-Class Ski Resorts' },
  { stat: '1,600 km', label: 'of Hiking Trails' },
];
---

<BaseLayout title="Home" description="BanffBound - Your complete guide to Banff, Alberta. Everything to do, eat, drink, shop, and experience in the Canadian Rockies.">
  <!-- Hero Slideshow -->
  <section class="hero" id="hero">
    <div class="hero-slides">
      <img src="https://images.unsplash.com/photo-1561134643-668f9057cce4?w=1800&q=80" alt="Mount Rundle reflected in Vermilion Lakes at sunrise" class="hero-slide active" />
      <img src="https://images.unsplash.com/photo-1503614472-8c93d56e92ce?w=1800&q=80" alt="Moraine Lake and the Valley of the Ten Peaks" class="hero-slide" />
      <img src="https://images.unsplash.com/photo-1503614472-8c93d56e92ce?w=1800&q=80" alt="Lake Louise turquoise waters with Victoria Glacier" class="hero-slide" />
      <img src="https://images.unsplash.com/photo-1609198092458-38a293c7ac4b?w=1800&q=80" alt="Snow-capped peaks in Banff National Park" class="hero-slide" />
      <img src="https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=1800&q=80" alt="Peyto Lake aerial turquoise view" class="hero-slide" />
    </div>
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <p class="hero-eyebrow">Named Best Place to Travel 2026 by National Geographic</p>
      <h1>Your Guide to<br/><span class="hero-accent">Banff National Park</span></h1>
      <p class="hero-sub">Plan your perfect escape to the Canadian Rockies. Iconic lakes, world-class skiing, mountain dining, and adventures that stay with you forever.</p>
      <div class="hero-buttons">
        <a href="/trip-builder" class="btn btn-accent">Build Your Trip</a>
        <a href="/things-to-do" class="btn btn-outline" style="border-color: white; color: white;">Explore Banff</a>
      </div>
    </div>
    <div class="hero-scroll-hint">
      <span>Scroll to explore</span>
      <div class="scroll-arrow"></div>
    </div>
  </section>

  <!-- Stats -->
  <section class="stats-bar">
    <div class="container">
      <div class="stats-grid">
        {highlights.map(h => (
          <div class="stat-item">
            <span class="stat-number">{h.stat}</span>
            <span class="stat-label">{h.label}</span>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Categories -->
  <section class="section">
    <div class="container">
      <div class="section-header">
        <span class="badge">Explore Banff</span>
        <h2>Everything You Need to Know</h2>
        <p>Whether you're chasing powder, craving mountain cuisine, or looking for the perfect souvenir, we've got you covered.</p>
      </div>
      <div class="grid grid-2">
        {categories.map(cat => (
          <a href={cat.href} class="category-card card">
            <img src={cat.image} alt={cat.title} class="card-image" />
            <div class="card-body">
              <span class="category-icon" set:html={cat.icon}></span>
              <h3>{cat.title}</h3>
              <p>{cat.description}</p>
              <span class="card-link">Explore &rarr;</span>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Upcoming Events -->
  {upcomingEvents.length > 0 && (
    <section class="section" style="background: var(--color-bg-alt);">
      <div class="container">
        <div class="section-header">
          <span class="badge">What's Happening</span>
          <h2>Upcoming Events</h2>
          <p>Don't miss what's happening in Banff right now.</p>
        </div>
        <div class="grid grid-3">
          {upcomingEvents.map(event => (
            <a href={event.link} target="_blank" rel="noopener" class="event-preview card">
              <div class="card-body">
                <span class="event-dates">&#128197; {event.dates}</span>
                <h3>{event.title}</h3>
                <p>{event.description}</p>
                <span class="card-link">Learn More &rarr;</span>
              </div>
            </a>
          ))}
        </div>
        <div style="text-align: center; margin-top: 2rem;">
          <a href="/events" class="btn btn-outline">View All Events &rarr;</a>
        </div>
      </div>
    </section>
  )}

  <!-- Book Tours CTA -->
  <section class="section">
    <div class="container">
      <div class="tours-cta">
        <div class="tours-cta-content">
          <span class="badge">Book Now</span>
          <h2>Book Tours & Find Hotels</h2>
          <p>Browse guided adventures from top-rated local operators or find the perfect place to stay in Banff.</p>
          <div class="hero-buttons" style="justify-content: flex-start;">
            <a href="/tours" class="btn btn-accent">Browse Tours &rarr;</a>
            <a href="/hotels" class="btn btn-outline">Find Hotels &rarr;</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Guides -->
  <section class="section">
    <div class="container">
      <div class="section-header">
        <span class="badge">Travel Guides</span>
        <h2>Plan Your Trip</h2>
        <p>Expert guides and insider tips to help you make the most of your Banff adventure.</p>
      </div>
      <div class="grid grid-4">
        {featuredPosts.map(post => (
          <a href={`/blog/${post.slug}`} class="guide-card card">
            <img src={post.image} alt={post.title} class="card-image guide-image" />
            <div class="card-body">
              <span class="tag">{post.category}</span>
              <h3 class="guide-title">{post.title}</h3>
              <span class="card-link">{post.readTime} &rarr;</span>
            </div>
          </a>
        ))}
      </div>
      <div style="text-align: center; margin-top: 2rem;">
        <a href="/blog" class="btn btn-outline">View All Guides &rarr;</a>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="cta-section">
    <div class="container">
      <div class="cta-card">
        <div class="cta-content">
          <span class="badge">Plan Ahead</span>
          <h2>Ready for Your Banff Adventure?</h2>
          <p>Banff National Park requires a valid Parks Canada pass. Purchase yours before you arrive and skip the line at the gate.</p>
          <a href="https://www.pc.gc.ca/en/pn-np/ab/banff" target="_blank" rel="noopener" class="btn btn-primary">Get Your Park Pass &rarr;</a>
        </div>
        <img
          src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=600&q=80"
          alt="Scenic Banff landscape"
          class="cta-image"
        />
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .hero {
    position: relative;
    height: 100vh;
    min-height: 650px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--color-white);
    overflow: hidden;
  }

  .hero-slides {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  .hero-slide {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 1.5s ease-in-out;
    transform: scale(1.05);
    animation: heroZoom 8s ease-in-out infinite alternate;
  }

  .hero-slide.active {
    opacity: 1;
  }

  @keyframes heroZoom {
    from { transform: scale(1); }
    to { transform: scale(1.08); }
  }

  .hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(0,0,0,0.25) 0%, rgba(26,58,42,0.5) 50%, rgba(0,0,0,0.7) 100%);
    z-index: 1;
  }

  .hero-content {
    position: relative;
    z-index: 2;
    max-width: 800px;
    padding: 0 1.5rem;
  }

  .hero-eyebrow {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--color-accent);
    margin-bottom: 1rem;
    opacity: 1 !important;
  }

  .hero-content h1 {
    color: var(--color-white);
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    margin: 0 0 1.25rem;
    line-height: 1.1;
    text-shadow: 0 2px 40px rgba(0,0,0,0.3);
  }

  .hero-accent {
    color: var(--color-accent);
  }

  .hero-sub {
    font-size: 1.15rem;
    opacity: 0.9;
    margin-bottom: 2.5rem;
    line-height: 1.8;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .hero-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .hero-scroll-hint {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255,255,255,0.6);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .scroll-arrow {
    width: 20px;
    height: 20px;
    border-right: 2px solid rgba(255,255,255,0.5);
    border-bottom: 2px solid rgba(255,255,255,0.5);
    transform: rotate(45deg);
    animation: scrollBounce 2s ease infinite;
  }

  @keyframes scrollBounce {
    0%, 100% { transform: rotate(45deg) translateY(0); }
    50% { transform: rotate(45deg) translateY(6px); }
  }

  .stats-bar {
    background: var(--color-primary);
    color: var(--color-white);
    padding: 2.5rem 0;
    margin-top: -2px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
    text-align: center;
  }

  .stat-number {
    display: block;
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-accent);
  }

  .stat-label {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-top: 0.25rem;
    display: block;
  }

  .category-card {
    display: block;
  }

  .category-card .card-image {
    height: 240px;
  }

  .category-icon {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 0.5rem;
  }

  .card-link {
    display: inline-block;
    margin-top: 1rem;
    color: var(--color-primary);
    font-weight: 600;
    font-size: 0.9rem;
    transition: gap 0.2s ease;
  }

  .cta-section {
    padding: 2rem 0 4rem;
  }

  .cta-card {
    display: grid;
    grid-template-columns: 1fr 1fr;
    background: var(--color-primary);
    border-radius: var(--radius);
    overflow: hidden;
    color: var(--color-white);
  }

  .cta-content {
    padding: 3rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .cta-content h2 {
    color: var(--color-white);
    margin: 0.5rem 0 1rem;
  }

  .cta-content p {
    opacity: 0.85;
    margin-bottom: 1.5rem;
    line-height: 1.7;
  }

  .cta-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    min-height: 300px;
  }

  .event-preview {
    display: block;
  }

  .event-dates {
    font-size: 0.85rem;
    color: var(--color-primary);
    font-weight: 500;
    display: block;
    margin-bottom: 0.5rem;
  }

  .guide-card { display: block; }
  .guide-image { height: 160px; }
  .guide-title { font-size: 1rem; line-height: 1.4; }

  .tours-cta {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    border-radius: var(--radius);
    padding: 3rem;
    color: var(--color-white);
  }

  .tours-cta h2 {
    color: var(--color-white);
    margin: 0.5rem 0 1rem;
  }

  .tours-cta p {
    opacity: 0.85;
    margin-bottom: 1.5rem;
    max-width: 500px;
  }

  @media (max-width: 768px) {
    .hero { height: 85vh; min-height: 550px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .cta-card { grid-template-columns: 1fr; }
    .cta-image { max-height: 250px; }
    .tours-cta { padding: 2rem; }
    .hero-scroll-hint { display: none; }
  }
</style>

<script>
  const slides = document.querySelectorAll('.hero-slide');
  let current = 0;
  setInterval(() => {
    slides[current].classList.remove('active');
    current = (current + 1) % slides.length;
    slides[current].classList.add('active');
  }, 5000);
</script>
