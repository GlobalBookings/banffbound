---
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';

const seededReports = [
  {
    id: 'seed-1',
    name: 'Sarah M.',
    date: 'July 2024',
    title: 'Best Family Vacation Ever!',
    story: 'We spent a week in Banff with our two kids (ages 8 and 11) and it was the most magical trip we\'ve ever taken. Started with an easy hike to Johnston Canyon — the kids were amazed by the waterfalls. Lake Louise was even more beautiful than the photos. We rented a canoe and paddled across the turquoise water with Victoria Glacier as our backdrop. The Banff Gondola was a highlight — the kids loved spotting wildlife from the top. We ended each day with hot chocolate on our hotel balcony watching the sunset over the mountains. Already planning our return trip!',
    rating: 5,
    activities: ['Hiking', 'Lakes', 'Hot Springs'],
    photo: 'https://images.unsplash.com/photo-1503614472-8c93d56e92ce?w=600&q=80',
  },
  {
    id: 'seed-2',
    name: 'James K.',
    date: 'January 2024',
    title: 'Powder Paradise at Sunshine Village',
    story: 'Came to Banff for a 5-day ski trip with buddies and it absolutely delivered. Sunshine Village had the best powder we\'ve experienced in North America — over 30 cm of fresh snow on our second day. The terrain variety is incredible, from gentle groomers to serious chutes. After skiing, we\'d hit the Banff Upper Hot Springs to soak our tired muscles under the stars. The town has a great après-ski scene too. Three Bears Brewery became our go-to spot. If you\'re a skier and haven\'t been to Banff, you\'re missing out.',
    rating: 5,
    activities: ['Skiing', 'Hot Springs', 'Dining'],
    photo: 'https://images.unsplash.com/photo-1551524559-8af4e6624178?w=600&q=80',
  },
  {
    id: 'seed-3',
    name: 'Emily R.',
    date: 'September 2024',
    title: 'Larch Season is Pure Magic',
    story: 'I visited Banff in late September specifically for larch season and it exceeded every expectation. The hike to Larch Valley from Moraine Lake was challenging but SO worth it — thousands of golden larch trees against snow-capped peaks. It looked like a painting. I also drove the Icefields Parkway and stopped at every pullout. Peyto Lake from Bow Summit was the most incredible shade of blue I\'ve ever seen. The elk rut was happening in town — watched two bull elk sparring right on the golf course at sunset. Truly a once-in-a-lifetime experience.',
    rating: 5,
    activities: ['Hiking', 'Wildlife', 'Lakes'],
    photo: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=600&q=80',
  },
  {
    id: 'seed-4',
    name: 'Michael T.',
    date: 'August 2024',
    title: 'Solo Backpacking Adventure',
    story: 'Did a 4-day solo backpacking trip through the Egypt Lake area and it was transformative. Complete solitude, crystal-clear alpine lakes, and mountain scenery that makes you feel tiny and grateful. Saw grizzly tracks on the trail (kept my bear spray close!) and a massive bull moose at Shadow Lake. The backcountry campsites are well-maintained and the permit system keeps crowds manageable. Back in town, treated myself to an incredible dinner at Park Distillery and a well-earned craft beer. Banff\'s backcountry is world-class.',
    rating: 5,
    activities: ['Hiking', 'Wildlife'],
    photo: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&q=80',
  },
  {
    id: 'seed-5',
    name: 'Lisa & David W.',
    date: 'June 2024',
    title: 'Romantic Anniversary Getaway',
    story: 'We celebrated our 10th anniversary with 4 nights at the Fairmont Banff Springs and it was pure romance. The hotel itself is stunning — like staying in a castle. We did the couples\' spa treatment, had dinner at Eden at the Rimrock (phenomenal food), and hiked to Lake Agnes Tea House. The tea house was charming — fresh scones and tea at 2,000+ metres! Woke up early one morning for sunrise at Two Jack Lake and had it completely to ourselves. The light on Mount Rundle was unreal. Banff is officially our favourite place on earth.',
    rating: 5,
    activities: ['Hiking', 'Dining', 'Hot Springs'],
    photo: 'https://images.unsplash.com/photo-1609198092458-38a293c7ac4b?w=600&q=80',
  },
  {
    id: 'seed-6',
    name: 'Chris P.',
    date: 'March 2024',
    title: 'Spring Skiing + Wildlife Combo',
    story: 'Visited in early March and got the best of both worlds — spring skiing conditions with bluebird days, plus incredible wildlife sightings. Lake Louise ski area was fantastic, especially the back bowls with soft spring snow. On our day off from skiing, we drove the Bow Valley Parkway and spotted two black bears just waking up from hibernation! Also did the Johnston Canyon ice walk — walking on frozen waterfalls is surreal. The days are longer in March and the vibe is so much more relaxed than peak winter.',
    rating: 4,
    activities: ['Skiing', 'Wildlife', 'Hiking'],
    photo: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=600&q=80',
  },
  {
    id: 'seed-7',
    name: 'Anika S.',
    date: 'December 2024',
    title: 'A Winter Wonderland Christmas',
    story: 'Spent Christmas week in Banff and it was like living inside a snow globe. The town was decorated beautifully and there was fresh snow every day. We went dog sledding through Spray Valley — the huskies were so enthusiastic and the scenery was breathtaking. Ice skating on Lake Louise under the lit-up chateau was magical. The kids went crazy at the Christmas market. Even just walking around town with hot chocolate watching the snow fall was perfect. Bundle up though — it was -25°C some mornings! Totally worth it.',
    rating: 5,
    activities: ['Skiing', 'Hot Springs', 'Shopping', 'Dining'],
    photo: 'https://images.unsplash.com/photo-1491002052546-bf38f186af56?w=600&q=80',
  },
  {
    id: 'seed-8',
    name: 'Marcus J.',
    date: 'July 2024',
    title: 'Photography Trip of a Lifetime',
    story: 'As a landscape photographer, Banff had been on my bucket list for years. Finally made the trip and it delivered beyond imagination. Moraine Lake at sunrise is the most photogenic place I\'ve ever shot — the reflection of the Valley of the Ten Peaks in perfectly still water was surreal. Spent golden hour at Vermilion Lakes with Mount Rundle reflected in the marsh. Got up at 3 AM for Spirit Island on Maligne Lake (worth every lost hour of sleep). My advice: go in July for the longest days and clearest water. Bring a wide-angle and a telephoto — you\'ll need both!',
    rating: 5,
    activities: ['Hiking', 'Lakes', 'Wildlife'],
    photo: 'https://images.unsplash.com/photo-1472791108553-c9405341e398?w=600&q=80',
  },
  {
    id: 'seed-9',
    name: 'Rachel & Tom B.',
    date: 'October 2024',
    title: 'Quiet Fall Escape',
    story: 'We visited Banff in mid-October hoping to avoid crowds and we were rewarded with an incredibly peaceful experience. Many trails were nearly empty. The larch trees at higher elevations still had some golden colour. We drove the Icefields Parkway with barely any traffic — stopped at every viewpoint and turquoise lake. The weather was cool but manageable with layers. Had amazing dinners at The Bison and Nourish — no reservations needed! Our hotel was half the price of summer rates. If you don\'t mind cooler weather, October is the secret best time to visit.',
    rating: 4,
    activities: ['Hiking', 'Dining', 'Lakes'],
    photo: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=600&q=80',
  },
  {
    id: 'seed-10',
    name: 'Jordan L.',
    date: 'February 2024',
    title: 'Snowshoeing & Hot Springs Bliss',
    story: 'Came to Banff in February for a quieter winter experience (not a big skier) and discovered snowshoeing is absolutely amazing. Rented snowshoes in town and explored Sundance Canyon and the Spray River trail — walking through deep snow in complete silence with mountains towering above was incredibly meditative. After snowshoeing, we\'d head straight to the Upper Hot Springs. Sitting in 38°C water while it\'s -20°C outside with snow falling on your face is a top-tier life experience. Also did the Lake Minnewanka ice walk and the frozen bubbles were otherworldly.',
    rating: 4,
    activities: ['Hot Springs', 'Hiking', 'Wildlife'],
    photo: 'https://images.unsplash.com/photo-1418985991508-e47386d96a71?w=600&q=80',
  },
];

const seededData = JSON.stringify(seededReports);
---

<BaseLayout title="Trip Reports — Banff Travel Stories" description="Read real trip reports from Banff visitors. Share your own Banff travel story and help others plan their mountain adventure.">
  <div class="container">
    <Breadcrumbs items={[{ label: 'Trip Reports' }]} />
  </div>

  <section class="page-hero">
    <img src="https://images.unsplash.com/photo-1472791108553-c9405341e398?w=1600&q=80" alt="Travellers enjoying Banff National Park" class="page-hero-bg" loading="eager" fetchpriority="high" />
    <div class="page-hero-content">
      <span class="badge">Community</span>
      <h1>Trip Reports</h1>
      <p>Real stories from real travellers. Read about their Banff adventures and share your own.</p>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="reports-header">
        <div>
          <span class="result-count" id="report-count">{seededReports.length} trip reports</span>
        </div>
        <button class="btn btn-accent" id="share-btn">✏️ Share Your Trip</button>
      </div>

      <div class="reports-grid" id="reports-grid">
        {seededReports.map(report => (
          <div class="report-card" data-id={report.id} data-expanded="false">
            {report.photo && <img src={report.photo} alt={report.title} class="report-card-img" loading="lazy" />}
            <div class="report-card-body">
              <div class="report-meta">
                <span class="report-name">{report.name}</span>
                <span class="report-date">{report.date}</span>
              </div>
              <div class="report-stars">{'★'.repeat(report.rating)}{'☆'.repeat(5 - report.rating)}</div>
              <h3>{report.title}</h3>
              <p class="report-story">{report.story.slice(0, 150)}...</p>
              <p class="report-story-full" style="display:none;">{report.story}</p>
              <button class="expand-btn">Read More ↓</button>
              <div class="report-tags">
                {report.activities.map(a => <span class="activity-tag">{a}</span>)}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Share Modal -->
  <div class="modal-overlay" id="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h2>Share Your Banff Trip</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <form id="report-form">
        <div class="form-group">
          <label for="report-name">Your Name</label>
          <input type="text" id="report-name" required placeholder="e.g. Sarah M." />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="report-month">Month</label>
            <select id="report-month" required>
              <option value="">Select...</option>
              <option>January</option><option>February</option><option>March</option>
              <option>April</option><option>May</option><option>June</option>
              <option>July</option><option>August</option><option>September</option>
              <option>October</option><option>November</option><option>December</option>
            </select>
          </div>
          <div class="form-group">
            <label for="report-year">Year</label>
            <select id="report-year" required></select>
          </div>
        </div>
        <div class="form-group">
          <label for="report-title">Trip Title</label>
          <input type="text" id="report-title" required placeholder="e.g. Best Summer Hike Ever!" />
        </div>
        <div class="form-group">
          <label for="report-story">Your Story</label>
          <textarea id="report-story" rows="5" required placeholder="Tell us about your Banff adventure..."></textarea>
        </div>
        <div class="form-group">
          <label>Rating</label>
          <div class="star-input" id="star-input">
            <span class="star-btn" data-val="1">☆</span>
            <span class="star-btn" data-val="2">☆</span>
            <span class="star-btn" data-val="3">☆</span>
            <span class="star-btn" data-val="4">☆</span>
            <span class="star-btn" data-val="5">☆</span>
          </div>
          <input type="hidden" id="report-rating" value="0" />
        </div>
        <div class="form-group">
          <label>Activities</label>
          <div class="checkbox-grid">
            <label class="checkbox-label"><input type="checkbox" value="Hiking" /> Hiking</label>
            <label class="checkbox-label"><input type="checkbox" value="Skiing" /> Skiing</label>
            <label class="checkbox-label"><input type="checkbox" value="Wildlife" /> Wildlife</label>
            <label class="checkbox-label"><input type="checkbox" value="Lakes" /> Lakes</label>
            <label class="checkbox-label"><input type="checkbox" value="Dining" /> Dining</label>
            <label class="checkbox-label"><input type="checkbox" value="Hot Springs" /> Hot Springs</label>
            <label class="checkbox-label"><input type="checkbox" value="Shopping" /> Shopping</label>
          </div>
        </div>
        <div class="form-group">
          <label for="report-photo">Photo URL (optional)</label>
          <input type="url" id="report-photo" placeholder="https://..." />
        </div>
        <button type="submit" class="btn btn-primary">Submit Trip Report</button>
      </form>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ seededData }}>
  const STORAGE_KEY = 'banffbound_trip_reports';
  const seededReports = JSON.parse(seededData);

  function getUserReports() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    } catch { return []; }
  }

  function saveUserReport(report) {
    const reports = getUserReports();
    reports.unshift(report);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
  }

  function renderUserReports() {
    const userReports = getUserReports();
    if (!userReports.length) return;

    const grid = document.getElementById('reports-grid');
    const countEl = document.getElementById('report-count');
    const total = seededReports.length + userReports.length;
    countEl.textContent = `${total} trip reports`;

    userReports.forEach(report => {
      const card = document.createElement('div');
      card.className = 'report-card';
      card.dataset.id = report.id;
      card.dataset.expanded = 'false';
      card.innerHTML = `
        ${report.photo ? `<img src="${report.photo}" alt="${report.title}" class="report-card-img" loading="lazy" />` : ''}
        <div class="report-card-body">
          <div class="report-meta">
            <span class="report-name">${report.name}</span>
            <span class="report-date">${report.date}</span>
          </div>
          <div class="report-stars">${'★'.repeat(report.rating)}${'☆'.repeat(5 - report.rating)}</div>
          <h3>${report.title}</h3>
          <p class="report-story">${report.story.slice(0, 150)}...</p>
          <p class="report-story-full" style="display:none;">${report.story}</p>
          <button class="expand-btn">Read More ↓</button>
          <div class="report-tags">
            ${report.activities.map(a => `<span class="activity-tag">${a}</span>`).join('')}
          </div>
        </div>
      `;
      grid.insertBefore(card, grid.firstChild);
    });

    attachExpandHandlers();
  }

  function attachExpandHandlers() {
    document.querySelectorAll('.expand-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const card = btn.closest('.report-card');
        const expanded = card.dataset.expanded === 'true';
        const excerpt = card.querySelector('.report-story');
        const full = card.querySelector('.report-story-full');

        if (expanded) {
          excerpt.style.display = '';
          full.style.display = 'none';
          btn.textContent = 'Read More ↓';
          card.dataset.expanded = 'false';
        } else {
          excerpt.style.display = 'none';
          full.style.display = '';
          btn.textContent = 'Show Less ↑';
          card.dataset.expanded = 'true';
        }
      });
    });
  }

  // Modal
  const overlay = document.getElementById('modal-overlay');
  const shareBtn = document.getElementById('share-btn');
  const closeBtn = document.getElementById('modal-close');
  const form = document.getElementById('report-form');

  shareBtn.addEventListener('click', () => { overlay.style.display = 'flex'; });
  closeBtn.addEventListener('click', () => { overlay.style.display = 'none'; });
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });

  // Year dropdown
  const yearSelect = document.getElementById('report-year');
  const currentYear = new Date().getFullYear();
  for (let y = currentYear; y >= currentYear - 5; y--) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  }

  // Star rating
  let selectedRating = 0;
  const starBtns = document.querySelectorAll('.star-btn');
  const ratingInput = document.getElementById('report-rating');

  starBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      selectedRating = Number(btn.dataset.val);
      ratingInput.value = selectedRating;
      starBtns.forEach((s, i) => {
        s.textContent = i < selectedRating ? '★' : '☆';
      });
    });
    btn.addEventListener('mouseenter', () => {
      const val = Number(btn.dataset.val);
      starBtns.forEach((s, i) => {
        s.textContent = i < val ? '★' : '☆';
      });
    });
  });

  document.getElementById('star-input').addEventListener('mouseleave', () => {
    starBtns.forEach((s, i) => {
      s.textContent = i < selectedRating ? '★' : '☆';
    });
  });

  // Submit
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (selectedRating === 0) { alert('Please select a rating.'); return; }

    const activities = [];
    form.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => activities.push(cb.value));

    const report = {
      id: 'user-' + Date.now(),
      name: document.getElementById('report-name').value.trim(),
      date: `${document.getElementById('report-month').value} ${document.getElementById('report-year').value}`,
      title: document.getElementById('report-title').value.trim(),
      story: document.getElementById('report-story').value.trim(),
      rating: selectedRating,
      activities,
      photo: document.getElementById('report-photo').value.trim() || '',
    };

    saveUserReport(report);
    overlay.style.display = 'none';
    form.reset();
    selectedRating = 0;
    starBtns.forEach(s => { s.textContent = '☆'; });

    // Re-render
    const grid = document.getElementById('reports-grid');
    const card = document.createElement('div');
    card.className = 'report-card';
    card.dataset.id = report.id;
    card.dataset.expanded = 'false';
    card.innerHTML = `
      ${report.photo ? `<img src="${report.photo}" alt="${report.title}" class="report-card-img" loading="lazy" />` : ''}
      <div class="report-card-body">
        <div class="report-meta">
          <span class="report-name">${report.name}</span>
          <span class="report-date">${report.date}</span>
        </div>
        <div class="report-stars">${'★'.repeat(report.rating)}${'☆'.repeat(5 - report.rating)}</div>
        <h3>${report.title}</h3>
        <p class="report-story">${report.story.slice(0, 150)}...</p>
        <p class="report-story-full" style="display:none;">${report.story}</p>
        <button class="expand-btn">Read More ↓</button>
        <div class="report-tags">
          ${report.activities.map(a => `<span class="activity-tag">${a}</span>`).join('')}
        </div>
      </div>
    `;
    grid.insertBefore(card, grid.firstChild);

    const countEl = document.getElementById('report-count');
    const count = grid.querySelectorAll('.report-card').length;
    countEl.textContent = `${count} trip reports`;

    attachExpandHandlers();
  });

  // Init
  renderUserReports();
  attachExpandHandlers();
</script>

<style>
  .reports-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .result-count {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-primary);
  }

  .btn {
    padding: 0.6rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }

  .btn-accent {
    background: var(--color-accent);
    color: white;
  }

  .btn-accent:hover { opacity: 0.9; }

  .btn-primary {
    background: var(--color-primary);
    color: white;
    width: 100%;
    padding: 0.75rem;
    font-size: 1rem;
  }

  .btn-primary:hover { opacity: 0.9; }

  .reports-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
  }

  .report-card {
    background: var(--color-white, #fff);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: all 0.2s;
  }

  .report-card:hover {
    box-shadow: var(--shadow-lg);
  }

  .report-card-img {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .report-card-body {
    padding: 1.25rem;
  }

  .report-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
  }

  .report-name {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--color-primary);
  }

  .report-date {
    font-size: 0.78rem;
    color: var(--color-text-light);
  }

  .report-stars {
    color: var(--color-accent);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .report-card-body h3 {
    font-size: 1.05rem;
    margin-bottom: 0.5rem;
  }

  .report-story, .report-story-full {
    font-size: 0.88rem;
    color: var(--color-text-light);
    line-height: 1.6;
  }

  .expand-btn {
    background: none;
    border: none;
    color: var(--color-accent);
    font-weight: 600;
    font-size: 0.82rem;
    cursor: pointer;
    padding: 0;
    margin-top: 0.5rem;
  }

  .expand-btn:hover { color: var(--color-primary); }

  .report-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.75rem;
  }

  .activity-tag {
    background: var(--color-bg-alt);
    color: var(--color-text);
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 500;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal {
    background: var(--color-white, #fff);
    border-radius: var(--radius);
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 2rem;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .modal-header h2 { font-size: 1.3rem; }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-light);
    line-height: 1;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: var(--color-text);
  }

  .form-group input[type="text"],
  .form-group input[type="url"],
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.55rem 0.75rem;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--color-primary);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .star-input {
    display: flex;
    gap: 0.25rem;
  }

  .star-btn {
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-accent);
    user-select: none;
  }

  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 0.5rem;
  }

  .checkbox-label {
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    cursor: pointer;
  }

  @media (max-width: 768px) {
    .reports-grid { grid-template-columns: 1fr; }
    .reports-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
    .modal { padding: 1.25rem; }
  }
</style>
