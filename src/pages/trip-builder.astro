---
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import { activities, tripTemplates, hotelLink } from '../data/tripActivities';

const activityMap = Object.fromEntries(activities.map(a => [a.id, a]));
---

<BaseLayout title="Trip Builder" description="Plan your perfect Banff trip day by day. Choose a template or build your own itinerary with booking links for tours, hotels, and activities.">
  <div class="container">
    <Breadcrumbs items={[{ label: 'Trip Builder' }]} />
  </div>
  <section class="page-hero">
    <img src="https://images.unsplash.com/photo-1609198092458-38a293c7ac4b?w=1600&q=80" alt="Banff National Park" class="page-hero-bg" loading="eager" fetchpriority="high" />
    <div class="page-hero-content">
      <span class="badge">Plan Your Trip</span>
      <h1>Banff Trip Builder</h1>
      <p>Choose a ready-made itinerary or build your own. Every activity includes booking links so you can secure your spots.</p>
    </div>
  </section>

  <!-- Template Selector -->
  <section class="templates-section">
    <div class="container">
      <div class="section-header">
        <h2>Choose Your Adventure</h2>
        <p>Pick a template that matches your style, then customize it to fit your trip.</p>
      </div>
      <div class="templates-grid">
        {tripTemplates.map((tmpl, i) => (
          <button class="template-card" data-template={tmpl.id} data-index={i}>
            <span class="template-style">{tmpl.style}</span>
            <h3>{tmpl.name}</h3>
            <p>{tmpl.description}</p>
            <div class="template-meta">
              <span>{tmpl.days} Days</span>
              <span>&middot;</span>
              <span>{tmpl.season === 'all' ? 'Year-round' : tmpl.season === 'summer' ? 'Summer' : 'Winter'}</span>
            </div>
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Itineraries (all rendered, shown/hidden via JS) -->
  {tripTemplates.map((tmpl, i) => (
    <section class="itinerary-section" data-itinerary={tmpl.id} style="display:none;">
      <div class="container">
        <div class="itinerary-header">
          <div>
            <span class="badge">{tmpl.style}</span>
            <h2>{tmpl.name}</h2>
            <p>{tmpl.description}</p>
          </div>
          <button class="btn btn-outline change-template-btn">Change Template</button>
        </div>

        {tmpl.itinerary.map((day) => {
          const dayActivities = day.activityIds.map(id => activityMap[id]).filter(Boolean);
          const bookable = dayActivities.filter(a => a.bookingUrl);
          return (
            <div class="day-block">
              <div class="day-header">
                <h3>{day.dayLabel}</h3>
                <span class="day-count">{dayActivities.length} activities</span>
              </div>

              <div class="day-activities">
                {dayActivities.map(act => (
                  <div class="activity-card">
                    <div class="activity-icon">{act.icon}</div>
                    <div class="activity-info">
                      <div class="activity-top">
                        <strong>{act.name}</strong>
                        {act.price && <span class="activity-price">{act.price}</span>}
                      </div>
                      <p>{act.description}</p>
                      <div class="activity-tags">
                        <span class="tag">{act.duration}</span>
                        <span class="tag">{act.difficulty}</span>
                        <span class="tag">{act.timeOfDay}</span>
                      </div>
                      {act.bookingUrl && (
                        <a href={act.bookingUrl} target="_blank" rel="noopener" class="book-btn">
                          Book Now &rarr;
                        </a>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              <div class="hotel-box">
                <div class="hotel-box-content">
                  <span class="hotel-icon">&#127968;</span>
                  <div>
                    <strong>Need a place to stay?</strong>
                    <p>Compare Banff hotels for this night on Expedia.</p>
                  </div>
                </div>
                <div class="hotel-links">
                  <a href={hotelLink('budget')} target="_blank" rel="noopener" class="hotel-link">Budget $</a>
                  <a href={hotelLink('mid')} target="_blank" rel="noopener" class="hotel-link">Mid-Range $$</a>
                  <a href={hotelLink('luxury')} target="_blank" rel="noopener" class="hotel-link">Luxury $$$</a>
                </div>
              </div>
            </div>
          );
        })}

        <!-- Summary -->
        <div class="trip-summary">
          <div class="summary-stats">
            <div class="summary-stat">
              <span class="summary-number">{tmpl.days}</span>
              <span>Days</span>
            </div>
            <div class="summary-stat">
              <span class="summary-number">{tmpl.itinerary.reduce((acc, d) => acc + d.activityIds.length, 0)}</span>
              <span>Activities</span>
            </div>
            <div class="summary-stat">
              <span class="summary-number">{tmpl.itinerary.reduce((acc, d) => acc + d.activityIds.filter(id => activityMap[id]?.bookingUrl).length, 0)}</span>
              <span>Bookable Tours</span>
            </div>
          </div>
          <div class="summary-ctas">
            <a href={`https://www.getyourguide.com/banff-l284/?partner_id=QW960HO`} target="_blank" rel="noopener" class="btn btn-accent">Browse All Banff Tours &rarr;</a>
            <a href={hotelLink('mid')} target="_blank" rel="noopener" class="btn btn-primary">Find Hotels on Expedia &rarr;</a>
          </div>
        </div>
      </div>
    </section>
  ))}
</BaseLayout>

<script>
  const templateCards = document.querySelectorAll('.template-card');
  const itineraries = document.querySelectorAll('.itinerary-section');
  const templatesSection = document.querySelector('.templates-section') as HTMLElement;
  const changeBtns = document.querySelectorAll('.change-template-btn');

  function showTemplate(id: string) {
    itineraries.forEach(s => (s as HTMLElement).style.display = 'none');
    const target = document.querySelector(`[data-itinerary="${id}"]`) as HTMLElement;
    if (target) {
      target.style.display = 'block';
      templatesSection.style.display = 'none';
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  function showSelector() {
    itineraries.forEach(s => (s as HTMLElement).style.display = 'none');
    templatesSection.style.display = 'block';
    templatesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  templateCards.forEach(card => {
    card.addEventListener('click', () => {
      const id = (card as HTMLElement).dataset.template || '';
      showTemplate(id);
    });
  });

  changeBtns.forEach(btn => btn.addEventListener('click', showSelector));
</script>

<style>
  .templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.5rem;
  }

  .template-card {
    background: var(--color-white);
    border: 2px solid transparent;
    border-radius: var(--radius);
    padding: 1.5rem;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: var(--shadow);
    font-family: var(--font-body);
  }

  .template-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .template-style {
    display: inline-block;
    background: var(--color-accent);
    color: var(--color-white);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    margin-bottom: 0.75rem;
  }

  .template-card h3 { margin-bottom: 0.5rem; font-size: 1.15rem; }
  .template-card p { color: var(--color-text-light); font-size: 0.9rem; margin-bottom: 0.75rem; }

  .template-meta {
    display: flex;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--color-text-light);
  }

  .itinerary-section { padding: 3rem 0; }

  .itinerary-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    gap: 1rem;
  }

  .itinerary-header h2 { margin: 0.25rem 0; }
  .itinerary-header p { color: var(--color-text-light); }

  .day-block {
    margin-bottom: 2.5rem;
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .day-header {
    background: var(--color-primary);
    color: var(--color-white);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .day-header h3 { color: var(--color-white); margin: 0; font-family: var(--font-body); font-size: 1rem; }
  .day-count { font-size: 0.85rem; opacity: 0.8; }

  .day-activities { padding: 1rem; }

  .activity-card {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .activity-card:hover { background: var(--color-bg-alt); }

  .activity-icon { font-size: 1.8rem; flex-shrink: 0; padding-top: 0.15rem; }

  .activity-info { flex: 1; }

  .activity-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
  }

  .activity-price {
    font-weight: 700;
    color: var(--color-primary);
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .activity-info p {
    color: var(--color-text-light);
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }

  .activity-tags { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; }

  .book-btn {
    display: inline-block;
    background: var(--color-accent);
    color: var(--color-white);
    padding: 0.35rem 0.9rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.2s;
  }

  .book-btn:hover { background: var(--color-primary); }

  .hotel-box {
    background: var(--color-bg-alt);
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .hotel-box-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .hotel-icon { font-size: 1.5rem; }
  .hotel-box-content p { font-size: 0.85rem; color: var(--color-text-light); margin: 0; }

  .hotel-links { display: flex; gap: 0.5rem; }

  .hotel-link {
    padding: 0.4rem 0.8rem;
    background: var(--color-white);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--color-primary);
    transition: all 0.2s;
  }

  .hotel-link:hover {
    background: var(--color-primary);
    color: var(--color-white);
    border-color: var(--color-primary);
  }

  .trip-summary {
    background: var(--color-white);
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow);
    text-align: center;
  }

  .summary-stats {
    display: flex;
    justify-content: center;
    gap: 3rem;
    margin-bottom: 1.5rem;
  }

  .summary-stat { display: flex; flex-direction: column; align-items: center; }

  .summary-number {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-accent);
  }

  .summary-stat span:last-child {
    font-size: 0.85rem;
    color: var(--color-text-light);
  }

  .summary-ctas {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .templates-section { padding: 3rem 0; }

  @media (max-width: 768px) {
    .itinerary-header { flex-direction: column; }
    .hotel-box { flex-direction: column; align-items: flex-start; }
    .hotel-links { flex-wrap: wrap; }
    .activity-card { flex-direction: column; }
    .activity-top { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
    .summary-stats { gap: 1.5rem; }
  }
</style>
